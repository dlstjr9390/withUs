<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"
          integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
  <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
  <title>회원 정보</title>

  <script th:inline="javascript">
    const host = 'http://' + window.location.host;

    $(document).ready(function(){

      const isSameMember = /*[[${isSameMember}]]*/ '';
      const memberId = /*[[${memberId}]]*/ '';
      console.log(memberId);

      if (isSameMember) {
        $('#chatting').hide();
        $('#inviting').hide();
      }

      $.ajax({
        type:'GET',
        url:`/api/member/`+ memberId,
        contentType: 'application/json',
        success: function(response){
          if(response.data.imageURL !== null){
            $('#profileImage').attr('src', response.data.imageURL);
          } else{
            $('#profileImage').attr('src', '/img/default.png');
          }

          $('#username').text(response.data.username);
          $('#email').text(response.data.email);
          $('#introduction').text(response.data.introduction);

          let tagArray = JSON.parse(response.data.tag);
          tagArray.forEach(function(tag) {
            $('#tag').append('#' + tag.trim()+'  ');
          });
        },
        error: function(error){
          console.error("에러 :", error)
        }
      });
    });

    function chattingClicked() {
      // 클릭되었을 때 실행할 동작을 정의
      var atk = localStorage.getItem("accessToken");
      var memberId = /*[[${memberId}]]*/ '';

      // 채팅방 생성 or 기존 roomId 가져오기
      $.ajax({
        type: 'POST',
        url: '/api/chat/' + memberId,
        contentType: 'application/json',
      })
      .done(function (res) {
        // 성공적으로 처리된 경우의 동작
        var roomId = res.data.roomId;
        // 채팅방으로 이동
        $.ajax({
          type: 'GET',
          url: '/api/chat/chatRoom/' + roomId,
          contentType: 'application/json',
        })
        .done(function (res, status, xhr) {
          window.location.href = host + '/api/chat/chatRoom/' + roomId;
        })


        console.log(roomId);
      })
      .fail(function (xhr, status, error) {
        // 실패한 경우의 동작
        console.error('채팅 요청 API 에러', error);
      });
    }

    function updateProfile(){
      var memberId = /*[[${memberId}]]*/ '';
      let url = '/api/member/updateProfilePage/' + memberId;
      location.href = url;
    }
  </script>
</head>
<body style="background-image: url('/img/background.jpg'); background-size: cover;">
<div style="margin: 40px 35% 200px 35%">
  <div>
    <img id="profileImage"
         style="border-radius: 100%; height: 170px; width: 170px; float:left"
         class="col-auto">
  </div>
  <div style="padding-top: 30px">
    <h5 id="username"></h5>
    <h5 style="margin-top: 50px" id="email"></h5>
  </div>
  <div style="margin-top:150px; background-color: beige">
    <h5 id="tag"></h5>
  </div>
  <div style="margin-top:100px; background-color: beige; height: 200px">
    <h5 id="introduction"></h5>
  </div>
  <div>
    <div class="d-grid col-3 mx-auto" style="padding: 15px 0 5px 0 ">
      <button type="button"
              class="btn btn-primary" onclick="updateProfile()">수정하기
      </button>
      <div style="margin-top:50px; margin-left: 15%" id="chatting" onclick="chattingClicked()">
        <img src="/img/message.png"
             style="border-radius: 100%; height: 85px; width: 85px; float:left"
             class="col-auto">
      </div>
      <div style="margin-top:50px; margin-left: 60% " id="inviting">
        <img src="/img/invite.png"
             style="border-radius: 100%; height: 100px; width: 100px; float:left"
             class="col-auto">
      </div>
    </div>
  </div>
</div>
</body>
</html>